<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå®æ–‡æ¡£å†…å®¹æå–æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .file-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        .file-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .file-info {
            font-size: 12px;
            color: #666;
        }
        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s ease;
        }
        .test-button:hover {
            background: #2980b9;
        }
        .test-button.secondary {
            background: #95a5a6;
        }
        .test-button.secondary:hover {
            background: #7f8c8d;
        }
        .result-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e3e3e3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .warning {
            color: #f39c12;
            font-weight: bold;
        }
        .status-info {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #e8f4fd;
            border-left: 4px solid #3498db;
        }
        .metadata {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .content-preview {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            background: white;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” çœŸå®æ–‡æ¡£å†…å®¹æå–æµ‹è¯•</h1>
            <p>æµ‹è¯•ä» uploads æ–‡ä»¶å¤¹ä¸­æå–çœŸå®æ–‡æ¡£å†…å®¹çš„åŠŸèƒ½</p>
        </div>

        <!-- åœ¨çº¿åŠ è½½åŠŸèƒ½ -->
        <div class="test-section">
            <h3>ğŸŒ åœ¨çº¿åŠ è½½åŠŸèƒ½</h3>
            <div class="info-box">
                <p><strong>âœ… è‡ªåŠ¨åœ¨çº¿åŠ è½½</strong></p>
                <p>ç³»ç»Ÿç°åœ¨æ”¯æŒç›´æ¥ä»åœ¨çº¿ URL è‡ªåŠ¨åŠ è½½æ–‡æ¡£æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨é€‰æ‹©ã€‚</p>
                <p><strong>åœ¨çº¿åœ°å€ï¼š</strong>https://huitaila.github.io/huitailang.github.io/uploads/</p>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ”§ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
            <div id="systemStatus">
                <p>æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</p>
            </div>
            <button class="test-button" onclick="checkSystemStatus()">é‡æ–°æ£€æŸ¥</button>
        </div>

        <!-- æ–‡æ¡£åˆ—è¡¨ -->
        <div class="test-section">
            <h3>ğŸ“ uploads æ–‡ä»¶å¤¹ä¸­çš„æ–‡æ¡£</h3>
            <div class="file-list" id="fileList">
                <!-- æ–‡ä»¶åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
            </div>
            <button class="test-button" onclick="loadFileList()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
        </div>

        <!-- å•ä¸ªæ–‡æ¡£æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ§ª å•ä¸ªæ–‡æ¡£æå–æµ‹è¯•</h3>
            <div class="status-info">
                <p><strong>è¯´æ˜ï¼š</strong>ç‚¹å‡»ä¸Šæ–¹æ–‡ä»¶åˆ—è¡¨ä¸­çš„ä»»æ„æ–‡æ¡£è¿›è¡Œå†…å®¹æå–æµ‹è¯•</p>
            </div>
            <div id="singleTestResult" class="result-area">
                <p>è¯·é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£è¿›è¡Œæµ‹è¯•...</p>
            </div>
        </div>

        <!-- æ‰¹é‡æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸš€ æ‰¹é‡æå–æµ‹è¯•</h3>
            <button class="test-button" onclick="runBatchTest()">å¼€å§‹æ‰¹é‡æµ‹è¯•</button>
            <button class="test-button secondary" onclick="clearBatchResults()">æ¸…é™¤ç»“æœ</button>
            <div id="batchTestResult" class="result-area">
                <p>ç‚¹å‡»"å¼€å§‹æ‰¹é‡æµ‹è¯•"æ¥æµ‹è¯•æ‰€æœ‰æ–‡æ¡£çš„å†…å®¹æå–...</p>
            </div>
        </div>

        <!-- æ€§èƒ½æµ‹è¯• -->
        <div class="test-section">
            <h3>âš¡ æ€§èƒ½æµ‹è¯•</h3>
            <button class="test-button" onclick="runPerformanceTest()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
            <div id="performanceResult" class="result-area">
                <p>ç‚¹å‡»"è¿è¡Œæ€§èƒ½æµ‹è¯•"æ¥æµ‹è¯•æ–‡æ¡£è§£ææ€§èƒ½...</p>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="scripts/common.js"></script>
    <script src="scripts/file-protocol-adapter.js"></script>
    <script src="scripts/document-parsers.js"></script>
    <script src="scripts/document-content-extractor.js"></script>

    <script>
        // å·²çŸ¥çš„æ–‡æ¡£æ–‡ä»¶åˆ—è¡¨
        const KNOWN_FILES = [
            'äº‘ç”µè„‘æ•™è‚²åœºæ™¯è§£å†³æ–¹æ¡ˆ.pptx',
            'æ™ºç®—ä¸€ä½“æœºå†…éƒ¨åŸ¹è®­ææ–™.pptx',
            'å…šæ”¿è¡Œä¸šé‡ç‚¹è§£å†³æ–¹æ¡ˆåŠæ¡ˆä¾‹.pptx',
            'æ³•åº“å¿å…¬å®‰å±€èæ™ºç®—é¡¹ç›®æ ‡æ†æ¡ˆä¾‹.docx',
            'ç§»åŠ¨äº‘åˆ†åœ°å¸‚ã€åˆ†è¡Œä¸šã€åˆ†å®¢ç¾¤å¾…æ‹“æ¸…å•åŠäº§å“æ‹“å±•æ–¹æ¡ˆ.pptx',
            'è¾½å®çœä¸­å°ä¼ä¸šæ•°å­—åŒ–è½¬å‹æ”¿ç­–.docx'
        ];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ');

            checkSystemStatus();
            loadFileList();
        });



        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</p></div>';

            try {
                let status = '<div class="status-info">';
                
                // æ£€æŸ¥æ–‡æ¡£è§£æå™¨
                if (window.DocumentParser) {
                    status += '<p class="success">âœ… DocumentParser å·²åŠ è½½</p>';
                } else {
                    status += '<p class="error">âŒ DocumentParser æœªåŠ è½½</p>';
                }

                // æ£€æŸ¥æ–‡æ¡£å†…å®¹æå–å™¨
                if (window.DocumentContentExtractor) {
                    status += '<p class="success">âœ… DocumentContentExtractor å·²åŠ è½½</p>';
                    
                    // æ£€æŸ¥æ˜¯å¦å‡†å¤‡å°±ç»ª
                    if (window.DocumentContentExtractor.isReady()) {
                        status += '<p class="success">âœ… æ–‡æ¡£è§£æå™¨å·²å‡†å¤‡å°±ç»ª</p>';
                    } else {
                        status += '<p class="warning">âš ï¸ æ–‡æ¡£è§£æå™¨æ­£åœ¨åˆå§‹åŒ–...</p>';
                        // å°è¯•åˆå§‹åŒ–
                        await window.DocumentContentExtractor.init();
                        if (window.DocumentContentExtractor.isReady()) {
                            status += '<p class="success">âœ… æ–‡æ¡£è§£æå™¨åˆå§‹åŒ–æˆåŠŸ</p>';
                        } else {
                            status += '<p class="error">âŒ æ–‡æ¡£è§£æå™¨åˆå§‹åŒ–å¤±è´¥</p>';
                        }
                    }
                } else {
                    status += '<p class="error">âŒ DocumentContentExtractor æœªåŠ è½½</p>';
                }

                // æ£€æŸ¥ç¼“å­˜ä¿¡æ¯
                if (window.DocumentContentExtractor && window.DocumentContentExtractor.getCacheInfo) {
                    const cacheInfo = window.DocumentContentExtractor.getCacheInfo();
                    status += `<p>ğŸ“Š ç¼“å­˜çŠ¶æ€ï¼š${cacheInfo.size} ä¸ªæ–‡æ¡£å·²ç¼“å­˜</p>`;
                }

                status += '</div>';
                statusDiv.innerHTML = status;

            } catch (error) {
                console.error('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                statusDiv.innerHTML = `<p class="error">âŒ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
            }
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function loadFileList() {
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '';

            KNOWN_FILES.forEach((filename, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.onclick = () => testSingleDocument(filename);
                
                const extension = filename.split('.').pop().toLowerCase();
                const emoji = extension === 'pptx' ? 'ğŸ“Š' : extension === 'docx' ? 'ğŸ“„' : 'ğŸ“‹';
                
                fileItem.innerHTML = `
                    <div class="file-name">${emoji} ${filename}</div>
                    <div class="file-info">æ ¼å¼: ${extension.toUpperCase()} | ç‚¹å‡»æµ‹è¯•æå–</div>
                `;
                
                fileListDiv.appendChild(fileItem);
            });
        }

        // æµ‹è¯•å•ä¸ªæ–‡æ¡£
        async function testSingleDocument(filename) {
            const resultDiv = document.getElementById('singleTestResult');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨æå–æ–‡æ¡£å†…å®¹ï¼š${filename}</p>
                </div>
            `;

            try {
                const startTime = performance.now();
                const result = await window.DocumentContentExtractor.extractDocumentContent(filename);
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                let resultHTML = `
                    <h4>ğŸ“„ ${filename}</h4>
                    <div class="metadata">
                        <p><strong>æå–çŠ¶æ€ï¼š</strong>${result.success ? '<span class="success">æˆåŠŸ</span>' : '<span class="error">å¤±è´¥</span>'}</p>
                        <p><strong>è€—æ—¶ï¼š</strong>${duration} ms</p>
                        <p><strong>æ ‡é¢˜ï¼š</strong>${result.title || 'æœªæå–åˆ°æ ‡é¢˜'}</p>
                        <p><strong>æ¥æºï¼š</strong>${result.source || 'æœªçŸ¥'}</p>
                `;

                if (result.fileSize) {
                    resultHTML += `<p><strong>æ–‡ä»¶å¤§å°ï¼š</strong>${formatFileSize(result.fileSize)}</p>`;
                }
                if (result.pageCount) {
                    resultHTML += `<p><strong>é¡µæ•°ï¼š</strong>${result.pageCount}</p>`;
                }

                resultHTML += '</div>';

                if (result.success && result.htmlContent) {
                    resultHTML += `
                        <h5>å†…å®¹é¢„è§ˆï¼š</h5>
                        <div class="content-preview">
                            ${result.htmlContent.substring(0, 1000)}${result.htmlContent.length > 1000 ? '...' : ''}
                        </div>
                    `;
                } else if (result.htmlContent) {
                    resultHTML += `
                        <h5>é”™è¯¯ä¿¡æ¯ï¼š</h5>
                        <div class="content-preview">
                            ${result.htmlContent}
                        </div>
                    `;
                }

                resultDiv.innerHTML = resultHTML;

            } catch (error) {
                console.error('æ–‡æ¡£æå–æµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `
                    <h4>âŒ æµ‹è¯•å¤±è´¥</h4>
                    <p class="error">é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>
                    <p>æ–‡ä»¶åï¼š${filename}</p>
                `;
            }
        }

        // æ‰¹é‡æµ‹è¯•
        async function runBatchTest() {
            const resultDiv = document.getElementById('batchTestResult');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨è¿›è¡Œæ‰¹é‡æµ‹è¯•...</p>
                </div>
            `;

            const results = [];
            const startTime = performance.now();

            for (let i = 0; i < KNOWN_FILES.length; i++) {
                const filename = KNOWN_FILES[i];
                
                // æ›´æ–°è¿›åº¦
                resultDiv.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨æµ‹è¯• ${i + 1}/${KNOWN_FILES.length}: ${filename}</p>
                    </div>
                `;

                try {
                    const fileStartTime = performance.now();
                    const result = await window.DocumentContentExtractor.extractDocumentContent(filename);
                    const fileEndTime = performance.now();
                    
                    results.push({
                        filename,
                        success: result.success,
                        duration: (fileEndTime - fileStartTime).toFixed(2),
                        title: result.title,
                        source: result.source,
                        fileSize: result.fileSize,
                        pageCount: result.pageCount,
                        error: result.error
                    });
                } catch (error) {
                    results.push({
                        filename,
                        success: false,
                        duration: 0,
                        error: error.message
                    });
                }
            }

            const totalTime = (performance.now() - startTime).toFixed(2);
            const successCount = results.filter(r => r.success).length;

            // æ˜¾ç¤ºç»“æœ
            let resultHTML = `
                <h4>ğŸ“Š æ‰¹é‡æµ‹è¯•ç»“æœ</h4>
                <div class="metadata">
                    <p><strong>æ€»è€—æ—¶ï¼š</strong>${totalTime} ms</p>
                    <p><strong>æˆåŠŸç‡ï¼š</strong>${successCount}/${KNOWN_FILES.length} (${((successCount/KNOWN_FILES.length)*100).toFixed(1)}%)</p>
                </div>
                <div class="results-list">
            `;

            results.forEach(result => {
                const statusIcon = result.success ? 'âœ…' : 'âŒ';
                const statusClass = result.success ? 'success' : 'error';
                
                resultHTML += `
                    <div class="result-item" style="margin: 10px 0; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                        <p><strong>${statusIcon} ${result.filename}</strong></p>
                        <p class="${statusClass}">çŠ¶æ€: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'} | è€—æ—¶: ${result.duration} ms</p>
                        ${result.title ? `<p>æ ‡é¢˜: ${result.title}</p>` : ''}
                        ${result.source ? `<p>æ¥æº: ${result.source}</p>` : ''}
                        ${result.error ? `<p class="error">é”™è¯¯: ${result.error}</p>` : ''}
                    </div>
                `;
            });

            resultHTML += '</div>';
            resultDiv.innerHTML = resultHTML;
        }

        // æ¸…é™¤æ‰¹é‡æµ‹è¯•ç»“æœ
        function clearBatchResults() {
            document.getElementById('batchTestResult').innerHTML = '<p>ç‚¹å‡»"å¼€å§‹æ‰¹é‡æµ‹è¯•"æ¥æµ‹è¯•æ‰€æœ‰æ–‡æ¡£çš„å†…å®¹æå–...</p>';
        }

        // æ€§èƒ½æµ‹è¯•
        async function runPerformanceTest() {
            const resultDiv = document.getElementById('performanceResult');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨è¿è¡Œæ€§èƒ½æµ‹è¯•...</p>
                </div>
            `;

            // é€‰æ‹©ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
            const testFile = KNOWN_FILES[0];
            const iterations = 5;
            const times = [];

            for (let i = 0; i < iterations; i++) {
                resultDiv.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>æ€§èƒ½æµ‹è¯•è¿›è¡Œä¸­ ${i + 1}/${iterations}</p>
                    </div>
                `;

                // æ¸…é™¤ç¼“å­˜
                if (window.DocumentContentExtractor.clearCache) {
                    window.DocumentContentExtractor.clearCache();
                }

                const startTime = performance.now();
                await window.DocumentContentExtractor.extractDocumentContent(testFile);
                const endTime = performance.now();
                
                times.push(endTime - startTime);
            }

            const avgTime = (times.reduce((a, b) => a + b, 0) / times.length).toFixed(2);
            const minTime = Math.min(...times).toFixed(2);
            const maxTime = Math.max(...times).toFixed(2);

            resultDiv.innerHTML = `
                <h4>âš¡ æ€§èƒ½æµ‹è¯•ç»“æœ</h4>
                <div class="metadata">
                    <p><strong>æµ‹è¯•æ–‡ä»¶ï¼š</strong>${testFile}</p>
                    <p><strong>æµ‹è¯•æ¬¡æ•°ï¼š</strong>${iterations}</p>
                    <p><strong>å¹³å‡è€—æ—¶ï¼š</strong>${avgTime} ms</p>
                    <p><strong>æœ€çŸ­è€—æ—¶ï¼š</strong>${minTime} ms</p>
                    <p><strong>æœ€é•¿è€—æ—¶ï¼š</strong>${maxTime} ms</p>
                </div>
                <div class="results-list">
                    <h5>è¯¦ç»†ç»“æœï¼š</h5>
                    ${times.map((time, index) => `<p>ç¬¬ ${index + 1} æ¬¡: ${time.toFixed(2)} ms</p>`).join('')}
                </div>
            `;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
