<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云电脑教育场景解决方案 - PPTX解析测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }
        .test-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #2980b9;
        }
        .test-button.secondary {
            background: #95a5a6;
        }
        .test-button.secondary:hover {
            background: #7f8c8d;
        }
        .test-results {
            margin-top: 20px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .debug-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .slide-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        .comparison-section h4 {
            margin-top: 0;
            color: #2d3748;
        }
        .slide-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            background: #fafafa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-header">
            <h1>📊 云电脑教育场景解决方案</h1>
            <h2>PPTX解析测试与对比</h2>
            <p>测试改进后的PowerPoint解析器是否能正确提取所有幻灯片内容</p>
        </div>

        <div class="test-controls">
            <button class="test-button" onclick="testNewParser()">🔧 测试新解析器</button>
            <button class="test-button secondary" onclick="testOldParser()">📄 测试旧解析器</button>
            <button class="test-button secondary" onclick="compareResults()">🔍 对比结果</button>
            <button class="test-button secondary" onclick="clearResults()">🗑️ 清除结果</button>
            <button class="test-button secondary" onclick="openOriginalFile()">🌐 查看原始文件</button>
        </div>

        <div class="test-results" id="testResults">
            <p>点击上方按钮开始测试...</p>
        </div>
    </div>

    <!-- 引入必要的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- 引入文档解析器 -->
    <script src="scripts/document-parsers.js"></script>
    <script src="scripts/document-content-extractor.js"></script>

    <script>
        let newParserResult = null;
        let oldParserResult = null;

        // 测试新解析器
        async function testNewParser() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="loading">🔧 正在使用新解析器测试...</div>';

            try {
                const filename = '云电脑教育场景解决方案.pptx';
                
                // 确保解析器已初始化
                if (!window.DocumentContentExtractor.isReady()) {
                    await window.DocumentContentExtractor.init();
                }
                
                // 清除缓存以确保使用最新解析器
                window.DocumentContentExtractor.clearCache();
                
                const result = await window.DocumentContentExtractor.extractDocumentContent(filename);
                newParserResult = result;
                
                if (result.success) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>✅ 新解析器测试成功!</h3>
                            <p><strong>文件:</strong> ${filename}</p>
                            <p><strong>标题:</strong> ${result.title}</p>
                            <p><strong>页数:</strong> ${result.pageCount}</p>
                            <p><strong>文件大小:</strong> ${result.fileSize ? formatFileSize(result.fileSize) : '未知'}</p>
                            <p><strong>来源:</strong> ${result.source}</p>
                            <p><strong>文本长度:</strong> ${result.textContent ? result.textContent.length : 0} 字符</p>
                        </div>
                        <div class="debug-info">
                            <h4>📝 提取的文本内容预览 (前1000字符):</h4>
                            <pre>${result.textContent ? result.textContent.substring(0, 1000) + '...' : '无文本内容'}</pre>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4>🎨 HTML渲染预览:</h4>
                            <div class="slide-preview">
                                ${window.DocumentContentExtractor.formatDocumentAsHTML(result)}
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>❌ 新解析器测试失败</h3>
                            <p><strong>文件:</strong> ${filename}</p>
                            <p><strong>错误:</strong> ${result.error || '未知错误'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ 测试过程中发生错误</h3>
                        <p><strong>错误信息:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        // 测试旧解析器（使用后备内容）
        async function testOldParser() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="loading">📄 正在使用旧解析器测试...</div>';

            try {
                const filename = '云电脑教育场景解决方案.pptx';
                
                // 直接使用后备内容
                const result = window.DocumentContentExtractor.getDocumentContent(filename);
                oldParserResult = result;
                
                if (result) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>✅ 旧解析器测试成功!</h3>
                            <p><strong>文件:</strong> ${filename}</p>
                            <p><strong>标题:</strong> ${result.title}</p>
                            <p><strong>来源:</strong> 静态后备内容</p>
                            <p><strong>内容长度:</strong> ${result.content ? result.content.length : 0} 字符</p>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4>🎨 HTML渲染预览:</h4>
                            <div class="slide-preview">
                                ${result.content}
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>❌ 旧解析器测试失败</h3>
                            <p><strong>文件:</strong> ${filename}</p>
                            <p><strong>错误:</strong> 未找到后备内容</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ 测试过程中发生错误</h3>
                        <p><strong>错误信息:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // 对比结果
        function compareResults() {
            const resultsDiv = document.getElementById('testResults');
            
            if (!newParserResult && !oldParserResult) {
                resultsDiv.innerHTML = '<div class="error">请先运行新解析器和旧解析器测试</div>';
                return;
            }

            let comparison = '<h3>🔍 解析结果对比</h3>';
            
            comparison += '<div class="slide-comparison">';
            
            // 新解析器结果
            comparison += '<div class="comparison-section">';
            comparison += '<h4>🔧 新解析器结果</h4>';
            if (newParserResult && newParserResult.success) {
                comparison += `
                    <p><strong>页数:</strong> ${newParserResult.pageCount}</p>
                    <p><strong>文本长度:</strong> ${newParserResult.textContent ? newParserResult.textContent.length : 0}</p>
                    <div class="slide-preview">
                        ${window.DocumentContentExtractor.formatDocumentAsHTML(newParserResult)}
                    </div>
                `;
            } else {
                comparison += '<p class="error">解析失败或未测试</p>';
            }
            comparison += '</div>';
            
            // 旧解析器结果
            comparison += '<div class="comparison-section">';
            comparison += '<h4>📄 旧解析器结果</h4>';
            if (oldParserResult) {
                comparison += `
                    <p><strong>内容长度:</strong> ${oldParserResult.content ? oldParserResult.content.length : 0}</p>
                    <div class="slide-preview">
                        ${oldParserResult.content}
                    </div>
                `;
            } else {
                comparison += '<p class="error">解析失败或未测试</p>';
            }
            comparison += '</div>';
            
            comparison += '</div>';
            
            resultsDiv.innerHTML = comparison;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '<p>结果已清除，点击上方按钮开始测试...</p>';
            newParserResult = null;
            oldParserResult = null;
        }

        function openOriginalFile() {
            window.open('https://huitaila.github.io/huitailang.github.io/uploads/云电脑教育场景解决方案.pptx', '_blank');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('云电脑教育场景解决方案PPTX测试页面已加载');
            
            // 检查必要的库是否已加载
            if (typeof JSZip === 'undefined') {
                document.getElementById('testResults').innerHTML = 
                    '<div class="error">❌ JSZip库未加载，请检查网络连接</div>';
            } else {
                console.log('✅ JSZip库已加载');
            }
        });
    </script>
</body>
</html>
